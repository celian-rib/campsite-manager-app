image: docker:latest
services:
  - docker:dind

variables:
  DOCKER_DRIVER: overlay
  SPRING_PROFILES_ACTIVE: gitlab-ci
  MAVEN_CLI_OPTS: "-s .m2/settings.xml --batch-mode"
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"

cache: 
    paths:
    - .m2/repository/
    - target/

stages:
  - install
  - test
  - codecoverage
  - codeQuality

include:
   - template: SAST.gitlab-ci.yml
   - template: Code-Quality.gitlab-ci.yml

install:
    image: maven:3.8-jdk-11-alpine
    stage: install 
    script:
        - mvn install:install-file -Dfile=ojdbc8.jar -DgroupId=com.oracle -DartifactId=ojdbc8 -Dversion=19.3 -Dpackaging=jar -DskipTests
        - mvn install

unittests:
    image: maven:3.8-jdk-11-alpine
    stage: test 
    script: 
        - mvn $MAVEN_CLI_OPTS test 
    artifacts:
        reports:
            junit:
                - target/surefire-reports/TEST-*.xml

code_quality:
   stage: codeQuality
   artifacts:
     reports:
       codequality: gl-code-quality-report.json
   after_script:
     - cat gl-code-quality-report.json

spotbugs-sast:
  dependencies:
    - build
  script:
    - /analyzer run -compile=false
  variables:
    MAVEN_REPO_PATH: ./.m2/repository
  artifacts:
    reports:
      sast: gl-sast-report.json

codecoverage:
    image: maven:3.8-jdk-11-alpine
    stage: codecoverage
    script:
        - mvn clean verify
    artifacts:
        paths:
            - target/site/jacoco/index.html
